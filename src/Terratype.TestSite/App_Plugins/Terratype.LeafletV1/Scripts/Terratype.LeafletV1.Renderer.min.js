(function(n){var t={id:"Terratype.LeafletV1",maps:[],_defaultProvider:{layers:[{maxZoom:18,id:"OpenStreetMap.Mapnik"}],zoomControl:{enable:!0,position:1}},ready:function(){return L&&L.MarkerClusterGroup&&n.terratype&&n.terratype.providers&&typeof n.terratype.providers[t.id]!="undefined"&&typeof n.terratype.providers[t.id].tileServers!="undefined"},_loadMap:function(i){return{_provider:t._defaultProvider?n.terratype._mergeJson(t._defaultProvider,i.provider):i.provider,_minZoom:null,_maxZoom:null,_layers:null,_bound:new L.latLngBounds,_center:null}},_loadCss:!1,_loadMarker:function(i,r,u){var o,h,s,c,f,e,v,l,a;if(i._layers==null&&r.provider.mapSources&&r.provider.mapSources.length!=0)for(i._layers=[],o=0;o!=r.provider.mapSources.length;o++)for(h=n.terratype.providers[t.id],s=0;s!=h.tileServers.length;s++)for(c=0;c!=h.tileServers[s].tileServers.length;c++)f=h.tileServers[s].tileServers[c],f.id==r.provider.mapSources[o].tileServer.id&&(e=JSON.parse(JSON.stringify(f.options)),e.minZoom=f.minZoom,e.maxZoom=f.maxZoom,e.attribution=f.attribution,e.key=r.provider.mapSources[o].key,i._layers.push(L.tileLayer(f.url,e)),(i._minZoom==null||f.minZoom<i._minZoom)&&(i._minZoom=f.minZoom),(i._maxZoom==null||f.maxZoom>i._minZoom)&&(i._maxZoom=f.maxZoom));r.position&&(v=n.terratype._parseLatLng(r.position.datum),l=new L.latLng(v.latitude,v.longitude),i._center==null&&(i._center=l),r.icon&&r.icon.url&&(i._bound.extend(l),a=[n.terratype._getAnchorHorizontal(r.icon.anchor.horizontal,r.icon.size.width),n.terratype._getAnchorVertical(r.icon.anchor.vertical,r.icon.size.height)],i.positions.push({id:id,tag:u.getAttribute("data-tag"),label:u.getAttribute("data-label-id"),position:r.position,_latlng:l,_icon:L.icon({iconUrl:n.terratype._configIconUrl(r.icon.url),iconSize:[r.icon.size.width,r.icon.size.height],iconAnchor:a,popupAnchor:[a[0]-r.icon.size.width/2,-a[1]]}),autoShowLabel:u.getAttribute("data-auto-show-label")?!0:!1})));n.terratype.providers[t.id]._loadCss==!1&&(n.terratype._loadCss(JSON.parse(unescape(u.getAttribute("data-css-files")))),n.terratype.providers[t.id]._loadCss=!0)},_render:function(i){i._ignoreEvents=0;i.autoFit&&(i._center=i._bound.getCenter());i.handle=L.map(document.getElementById(i._div),{center:i._center,zoom:i.zoom,minZoom:i._minZoom,maxZoom:i._maxZoom,layers:i._layers,scrollWheelZoom:!1,attributionControl:!1,zoomControl:!1});i._zoomControl=null;i._provider.zoomControl.enable&&(i._zoomControl=L.control.zoom({position:t._controlPosition(i._provider.zoomControl.position)}).addTo(i.handle));i.handle.on("zoomend",function(){i._ignoreEvents>0||(i.zoom=i.handle.getZoom(),n.terratype._callZoom(t,i,i.zoom))});i.handle.on("load",function(){if(!(i._ignoreEvents>0)){var r=document.getElementById(i._div);n.terratype._isElementInViewport(r)&&r.clientHeight!=0&&r.clientWidth!=0&&t.refresh(i)}});i.handle.on("resize",function(){i._ignoreEvents>0||t.refresh(i)});i.handle.on("click",function(){t.closeInfoWindows(i)});i._cluster=i.positions.length>1?L.markerClusterGroup({chunkedLoading:i.positions.length>100,zoomToBoundsOnClick:!0}):null;i._featureGroup=L.featureGroup().addTo(i.handle).on("click",function(n){t.openInfoWindow(i,n.layer.options.index)});n.terratype._forEach(i.positions,function(r,u){if(u.handle=L.marker(u._latlng,{index:r,draggable:!1,id:"terratype_"+u.id+"_marker",icon:u._icon}),u._info=null,u.label){var f=document.getElementById(u.label);f&&(u._info=u.handle.addTo(i._featureGroup).bindPopup(f.innerHTML),n.terratype._domDetectionType==2&&u.autoShowLabel&&n.setTimeout(function(){t.openInfoWindow(i,r)},100))}i._cluster!=null?i._cluster.addLayer(u.handle):u.handle.addTo(i.handle);u.handle.on("click",function(){n.terratype._callClick(t,i,u)})});i._cluster!=null&&i.handle.addLayer(i._cluster)},_controlPosition:function(n){switch(parseInt(n)){case 1:return"topleft";case 3:return"topright";case 10:return"bottomleft";case 12:return"bottomright"}return"topleft"},openInfoWindow:function(i,r){var u=i.positions[r];u._info.openPopup();n.terratype._callClick(t,i,u)},closeInfoWindows:function(n){n.handle.closePopup()},_checkResize:function(n){n.handle.getBounds().contains(n._center)||t.refresh(n)},_reset:function(i){if(i._refreshes==0&&(n.terratype._forEach(i.positions,function(r,u){u.autoShowLabel&&n.setTimeout(function(){t.openInfoWindow(i,r)},100)}),i._status=2),i._refreshes==0||i.recenterAfterRefresh){if(i.autoFit){i.handle.setZoom(i._maxZoom);var r=new L.latLngBounds(i._bound.getNorthEast(),i._bound.getSouthWest());i.handle.fitBounds(r)}i.zoom=i.handle.getZoom();i.handle.setView(i._center,i.zoom)}i._refreshes++==0?(n.terratype._opacityShow(i),n.terratype._callRender(t,i)):n.terratype._callRefresh(t,i)},refresh:function(n){n._ignoreEvents++;n.recenterAfterRefresh&&(n.handle.setZoom(n.zoom),n.handle.setView(n._center));n.handle.invalidateSize();setTimeout(function(){n._cluster!=null&&n._cluster.refreshClusters();t._reset(n);n._ignoreEvents--},1)}},i;n.terratype&&n.terratype._addProvider?n.terratype._addProvider(t.id,t):i=n.setInterval(function(){n.terratype&&n.terratype._addProvider&&(n.terratype._addProvider(t.id,t),n.clearInterval(i))},100)})(window);