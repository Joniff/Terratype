(function(n){var t,e,o,r,u,f,i,s;t.L.LatLng=function(n,t,i){var u=parseFloat(n,10),r=parseFloat(t,10);if(isNaN(u)||isNaN(r))throw new Error("Invalid LatLng object: ("+n+", "+t+")");return i!==!0&&(u=Math.max(Math.min(u,90),-90),r=(r+180)%360+(r<-180||r===180?180:-180)),{lat:u,lng:r}};t.L.LatLng.DEG_TO_RAD=Math.PI/180;t.L.LatLng.RAD_TO_DEG=180/Math.PI;t.LatLngToXYZ=function(n){var i=t.L.LatLng.DEG_TO_RAD,r=n.lat*i,u=n.lng*i,f=Math.cos(r);return[Math.cos(u)*f,Math.sin(u)*f,Math.sin(r)]};t.XYZToLatLng=function(n){var i=t.L.LatLng.RAD_TO_DEG,r=Math.atan2(n[2],Math.sqrt(n[0]*n[0]+n[1]*n[1])),u=Math.atan2(n[1],n[0]);return t.L.LatLng(r*i,u*i)};e=function(n){var t=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];return t[0]>t[1]?t[0]>t[2]?0:2:t[1]>t[2]?1:2};o=function(n,t){var i,r;switch(n){case 0:i=t[1]/t[0];r=t[2]/t[0];break;case 1:i=-t[0]/t[1];r=t[2]/t[1];break;case 2:i=-t[0]/t[2];r=-t[1]/t[2];break;case 3:i=t[2]/t[0];r=t[1]/t[0];break;case 4:i=t[2]/t[1];r=-t[0]/t[1];break;case 5:i=-t[1]/t[2];r=-t[0]/t[2];break;default:throw{error:"Invalid face"};}return[i,r]};t.XYZToFaceUV=function(n){var t=e(n),i;return n[t]<0&&(t+=3),i=o(t,n),[t,i]};t.FaceUVToXYZ=function(n,t){var i=t[0],r=t[1];switch(n){case 0:return[1,i,r];case 1:return[-i,1,r];case 2:return[-i,-r,1];case 3:return[-1,-r,-i];case 4:return[r,-1,-i];case 5:return[r,i,-1];default:throw{error:"Invalid face"};}};r=function(n){return n>=.5?1/3*(4*n*n-1):1/3*(1-4*(1-n)*(1-n))};t.STToUV=function(n){return[r(n[0]),r(n[1])]};u=function(n){return n>=0?.5*Math.sqrt(1+3*n):1-.5*Math.sqrt(1-3*n)};t.UVToST=function(n){return[u(n[0]),u(n[1])]};t.STToIJ=function(n,t){var i=1<<t,r=function(n){var t=Math.floor(n*i);return Math.max(0,Math.min(i-1,t))};return[r(n[0]),r(n[1])]};t.IJToST=function(n,t,i){var r=1<<t;return[(n[0]+i[0])/r,(n[1]+i[1])/r]};f=function(n,t,i,r){var h={a:[[0,"d"],[1,"a"],[3,"b"],[2,"a"]],b:[[2,"b"],[1,"b"],[3,"a"],[0,"c"]],c:[[2,"c"],[3,"d"],[1,"c"],[0,"b"]],d:[[0,"a"],[3,"c"],[1,"d"],[2,"d"]]},f,e,u;for("number"!=typeof r&&console.warn(new Error("called pointToHilbertQuadList without face value, defaulting to '0'").stack),f=r%2?"d":"a",e=[],u=i-1;u>=0;u--){var o=1<<u,c=n&o?1:0,l=t&o?1:0,s=h[f][c*2+l];e.push(s[0]);f=s[1]}return e};t.S2Cell=function(){};t.S2Cell.FromLatLng=function(n,i){if(!n.lat||!n.lng)throw new Error("Pass { lat: lat, lng: lng } to S2.S2Cell.FromLatLng");var u=t.LatLngToXYZ(n),r=t.XYZToFaceUV(u),f=t.UVToST(r[1]),e=t.STToIJ(f,i);return t.S2Cell.FromFaceIJ(r[0],e,i)};t.S2Cell.FromFaceIJ=function(n,i,r){var u=new t.S2Cell;return u.face=n,u.ij=i,u.level=r,u};t.S2Cell.prototype.toString=function(){return"F"+this.face+"ij["+this.ij[0]+","+this.ij[1]+"]@"+this.level};t.S2Cell.prototype.getLatLng=function(){var n=t.IJToST(this.ij,this.level,[.5,.5]),i=t.STToUV(n),r=t.FaceUVToXYZ(this.face,i);return t.XYZToLatLng(r)};t.S2Cell.prototype.getCornerLatLngs=function(){for(var i=[],r=[[0,0],[0,1],[1,1],[1,0]],n=0;n<4;n++){var u=t.IJToST(this.ij,this.level,r[n]),f=t.STToUV(u),e=t.FaceUVToXYZ(this.face,f);i.push(t.XYZToLatLng(e))}return i};t.S2Cell.prototype.getFaceAndQuads=function(){var n=f(this.ij[0],this.ij[1],this.level,this.face);return[this.face,n]};t.S2Cell.prototype.toHilbertQuadkey=function(){var n=f(this.ij[0],this.ij[1],this.level,this.face);return this.face.toString(10)+"/"+n.join("")};t.latLngToNeighborKeys=t.S2Cell.latLngToNeighborKeys=function(n,i,r){return t.S2Cell.FromLatLng({lat:n,lng:i},r).getNeighbors().map(function(n){return n.toHilbertQuadkey()})};t.S2Cell.prototype.getNeighbors=function(){var n=function(n,i,r){var e=1<<r;if(i[0]>=0&&i[1]>=0&&i[0]<e&&i[1]<e)return t.S2Cell.FromFaceIJ(n,i,r);var u=t.IJToST(i,r,[.5,.5]),f=t.STToUV(u),s=t.FaceUVToXYZ(n,f),o=t.XYZToFaceUV(s);return n=o[0],f=o[1],u=t.UVToST(f),i=t.STToIJ(u,r),t.S2Cell.FromFaceIJ(n,i,r)},i=this.face,r=this.ij[0],u=this.ij[1],f=this.level;return[n(i,[r-1,u],f),n(i,[r,u-1],f),n(i,[r+1,u],f),n(i,[r,u+1],f)]};t.FACE_BITS=3;t.MAX_LEVEL=30;t.POS_BITS=2*t.MAX_LEVEL+1;t.facePosLevelToId=t.S2Cell.facePosLevelToId=t.fromFacePosLevel=function(n,i,r){var o=exports.dcodeIO&&exports.dcodeIO.Long||require("long"),u,f,e;for(r||(r=i.length),i.length>r&&(i=i.substr(0,r)),u=o.fromString(n.toString(10),!0,10).toString(2);u.length<t.FACE_BITS;)u="0"+u;for(f=o.fromString(i,!0,4).toString(2);f.length<2*r;)f="0"+f;for(e=u+f,e+="1";e.length<t.FACE_BITS+t.POS_BITS;)e+="0";return o.fromString(e,!0,2).toString(10)};t.keyToId=t.S2Cell.keyToId=t.toId=t.toCellId=t.fromKey=function(n){var i=n.split("/");return t.fromFacePosLevel(i[0],i[1],i[1].length)};t.idToKey=t.S2Cell.idToKey=t.S2Cell.toKey=t.toKey=t.fromId=t.fromCellId=t.S2Cell.toHilbertQuadkey=t.toHilbertQuadkey=function(n){for(var u=exports.dcodeIO&&exports.dcodeIO.Long||require("long"),i=u.fromString(n,!0,10).toString(2);i.length<t.FACE_BITS+t.POS_BITS;)i="0"+i;for(var e=i.lastIndexOf("1"),o=i.substring(0,3),f=i.substring(3,e),s=f.length/2,h=u.fromString(o,!0,2).toString(10),r=u.fromString(f,!0,2).toString(4);r.length<s;)r="0"+r;return h+"/"+r};t.S2Cell.latLngToKey=t.latLngToKey=t.latLngToQuadkey=function(n,i,r){return t.S2Cell.FromLatLng({lat:n,lng:i},r).toHilbertQuadkey()};t.stepKey=function(n,t){var e=exports.dcodeIO&&exports.dcodeIO.Long||require("long"),r=n.split("/"),o=r[0],s=r[1],h=r[1].length,f=e.fromString(s,!0,4),u,i;for(t>0?u=f.add(Math.abs(t)):t<0&&(u=f.subtract(Math.abs(t))),i=u.toString(4),"0"===i&&console.warning(new Error("face/position wrapping is not yet supported"));i.length<h;)i="0"+i;return o+"/"+i};t.S2Cell.prevKey=t.prevKey=function(n){return t.stepKey(n,-1)};t.S2Cell.nextKey=t.nextKey=function(n){return t.stepKey(n,1)};i={_level:24,id:"Terratype.CoordinateSystems.S2",toWgs:function(n){var i=t.S2Cell.FromHilbertQuadKey(n).getCornerLatLngs();return{latitude:i.lat,longitude:i.lng}},fromWgs:function(n,r){return t.latLngToKey(n,r,i._level)}};n.terratype&&n.terratype._addCoordinateSystem?n.terratype._addCoordinateSystem(i.id,i):s=n.setInterval(function(){n.terratype&&n.terratype._addCoordinateSystem&&(n.terratype._addCoordinateSystem(i.id,i),n.clearInterval(s))},100)})(window);